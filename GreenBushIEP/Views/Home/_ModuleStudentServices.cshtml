@using GreenBushIEP.Models
@model StudentServiceViewModel

<style>
    .form-inline .form-group {
        margin-right: 10px;
    }

    .well-primary {
        color: rgb(255, 255, 255);
        background-color: rgb(66, 139, 202);
        border-color: rgb(53, 126, 189);
    }

    .panel-group {
        margin-bottom: 12px;
    }
</style>

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove-circle" style="font-size: 30px;"></span></button>
    <button type="button" class="tooltip-help" data-toggle="tooltip" data-placement="bottom" title="Follow the tooltips to learn how to user this form"><span class="glyphicon glyphicon-question-sign" style="font-size: 30px;"></span></button>
    <h4 class="modal-title" style="font-size: 30px;">
        <i class="fa fa-handshake-o" aria-hidden="true" style="font-size: smaller; "></i>&nbsp;Student Services
    </h4>
</div>
<div class="modal-body">

    <div class="container serviceContainer">
        <div class="row">
            <div class="col-md-12" style="margin-bottom: 12px;">
                <button id="newService" class="btn btn-default">New Student Service&nbsp;&nbsp;<i class="glyphicon glyphicon-plus"></i></button>
            </div>
        </div>

        <div class="row oneStudentService hidden" id="defaultStudentService">
            <div class="col-md-12">
                <div class="panel-group" id="accordion[0]">

                    <form action="/Home/saveStudentService" method="post">
                        <input type="hidden" name="StudentId" value="@Model.studentId" />
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordion[0]" href="#collapse0">
                                        <span class="studentGoalLabel" style="margin-left:5px;">Student Service</span>
                                        <span class="pull-right">
                                            <i class="glyphicon glyphicon-trash deleteGoal"></i>
                                        </span>
                                    </a>
                                </h4>
                            </div>
                            <div id="collapse0" class="collapse in">
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-2">

                                            <label for="fiscalYear">Fiscal Year</label>
                                            <div class="form-group">
                                                <select class="form-control" name="fiscalYear" style="border-color: #ccc; display: inline-block;">
                                                    <option value="2018">2017 - 2018</option>
                                                    <option value="2019">2019 - 2020</option>
                                                    <option value="2020">2020 - 2021</option>
                                                    <option value="2021">2020 - 2021</option>
                                                    <option value="2022">2021 - 2022</option>
                                                </select>
                                            </div>

                                        </div>
                                        <div class="col-md-3">
                                            <label for="Frequency">Start Date</label>
                                            <div class="input-group">
                                                <span class="input-group-addon" id="basic-addon1"><i class="glyphicon glyphicon-calendar"></i></span>
                                                <input id="serviceStartDate" name="serviceStartDate" title="" type="date" class="form-control" aria-describedby="basic-addon1">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="Frequency">End Date</label>
                                            <div class="input-group">
                                                <span class="input-group-addon" id="basic-addon1"><i class="glyphicon glyphicon-calendar"></i></span>
                                                <input id="serviceEndDate" name="serviceEndDate" title="" type="date" class="form-control" aria-describedby="basic-addon1">
                                            </div>
                                        </div>
                                        <div class="col-md-4">

                                            <label for="ServiceType">Service Type</label>
                                            <div class="form-group">
                                                <select class="form-control" name="ServiceType" style="border-color: #ccc; display: inline-block;">
                                                    @if (Model.serviceTypes.Count > 0)
                                                    {
                                                        foreach (var serviceType in Model.serviceTypes)
                                                        {
                                                            <option value="@serviceType.ServiceCode">(@serviceType.ServiceCode) @serviceType.Name</option>
                                                        }
                                                    }
                                                </select>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="form-group col-md-2" name="Frequency">

                                            <label for="Frequency">Frequency</label>
                                            <select class="form-control" name="Frequency" style="border-color: #ccc; display: inline-block;">
                                                <option value="1">Every week (1)</option>
                                                <option value="2">Every 2 weeks (2)</option>
                                                <option value="3">Every 3 weeks (3)</option>
                                                <option value="4">Every 4 weeks (4)</option>
                                                <option value="8">Every 8 weeks (8)</option>
                                                <option value="9">Every 9 weeks (9)</option>
                                                <option value="12">Every 12 weeks (12)</option>
                                                <option value="18">Every 18 weeks (18)</option>
                                                <option value="19">3 out of 4 weeks (19)</option>
                                                <option value="99">1 day per year (99)</option>
                                            </select>

                                        </div>
                                        <div class="form-group col-md-2" name="Days" style="padding-left: 0;">
                                            <label for="Days">Days per Week</label>
                                            <div class="input-group number-spinner">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                </span>
                                                <input type="text" name="serviceDaysPerWeek" class="form-control text-center" value="1" min="1" max="5">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="form-group col-md-2" name="Duration">
                                            <label for="Duration">Minutes per Day </label>
                                            <div class="input-group minute-spinner">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                </span>
                                                <input type="text" name="serviceMinutesPerDay" class="form-control text-center" value="1">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="form-group col-md-6" name="Frequency">

                                            <label for="Frequency">Provider</label>
                                            <select class="form-control" name="serviceProvider" style="border-color: #ccc; display: inline-block;">
                                                @if (Model.serviceProviders.Count > 0)
                                                {
                                                    foreach (var serviceProvider in Model.serviceProviders)
                                                    {
                                                        <option value="@serviceProvider.ProviderID">@serviceProvider.Name</option>
                                                    }
                                                }
                                                else
                                                {
                                                    <option value="-1">-- No providers currently available --</option>
                                                }
                                            </select>

                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-group" name="Location">

                                                <label for="Location">Location</label><br />
                                                <div class="form-group">
                                                    <select class="form-control" name="location" style="border-color: #ccc; display: inline-block;">
                                                        @if (Model.serviceLocations.Count > 0)
                                                        {
                                                            foreach (var serviceLocation in Model.serviceLocations)
                                                            {
                                                                <option value="@serviceLocation.LocationCode">(@serviceLocation.LocationCode) @serviceLocation.Name</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>

                                            </div>
                                        </div>
                                        <div class="col-md-7" s>

                                            <label for="studentGoals">Goal</label><br />
                                            <select class="form-control" id="studentGoalsSelect" style="border-color: #ccc; width: 300px; display: inline-block;">
                                                <option value="-1">-- Add a student goal to the service --</option>
                                                @if (Model.studentGoals.Count > 0)
                                                {
                                                    foreach (var goal in Model.studentGoals)
                                                    {
                                                        <option value="@goal.goalID" data-title="@goal.Title.ToString()">@goal.Title.ToString()</option>
                                                    }
                                                }
                                            </select>
                                            <span class="btn btn-default addServiceGoal" style="padding: 15px 12px; height: 50px; background: #ff9f1a; color: #fff; border-radius: 0; margin-left: -5px; margin-top: -3px;">
                                                <span class="glyphicon glyphicon-plus"></span>
                                            </span>

                                        </div>
                                        <div class="col-md-2 pull-right" style="margin-top: 33px;">
                                            <button type="reset" class="btn btn-default">Reset</button>
                                            <button type="submit" class="saveStudentService btn btn-primary"><i class="glyphicon glyphicon-floppy-disk"></i>&nbsp;Save</button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 StudentGoals">

                                            @if (Model.studentService.tblGoals.Count > 0)
                                            {
                                                foreach (var goal in Model.studentService.tblGoals)
                                                {
                                                    <div class="panel panel-info autocollapse serviceStudentGoal" style="margin: 5px 0">
                                                        <div class="panel-heading clickable">
                                                            <h3 class="panel-title">
                                                                <i class="fa fa-trophy"></i>&nbsp;@goal.Title.ToString()
                                                                <i class="pull-right glyphicon glyphicon-remove deletegoal"></i>
                                                                <input type="hidden" name="studentServiceGoal@goal.goalID"  value="@goal.goalID" />
                                                            </h3>
                                                        </div>
                                                    </div>
                                                }
                                            }

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>

    </div>

</div>
<div class="modal-footer">
    <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">Close</button>
</div>

<script>
    $('#serviceStartDate').prop('min', function () { return new Date().toJSON().split('T')[0]; });
    $('#serviceEndDate').prop('min', function () { return new Date().toJSON().split('T')[0]; });

    /* Binding */
    /* tooltips */
    $('[data-toggle="tooltip"]').tooltip({
        trigger: 'manual'
    });

    /* Event */
    /* When a user clicks on the question mark icon we turn on tooltips */
    $('.tooltip-help').on('click', function () {
        $('[data-toggle="tooltip"]').tooltip('toggle');
    });

    /* Event */
    /* when clicking on the New Student Goal button */
    $('#newService').on('click', function () {

        var cloneService = $("#defaultStudentService").clone();
        cloneService.removeClass("hidden");
        cloneService.removeAttr("id");

        // count the number of services and increment our counter in the accordian view.
        var serviceCount = $('.oneStudentService').not("#defaultStudentService").length + 1;
        cloneService.children().children().prop("id", "accordion[" + serviceCount + "]");

        // set up the accordian click event.
        var serviceA = cloneService.find('[data-parent="#accordion[0]"]').attr('data-parent', '#accordion[' + serviceCount + ']');
        serviceA.attr('href', '#collapse' + serviceCount);

        cloneService.find("#collapse0").prop("id", "collapse" + serviceCount);
        $('.serviceContainer').append(cloneService);

        initService();
    });

    function initService() {
        $('.oneStudentService').not('#defaultStudentService').not('.bound').addClass('bound').each(function (index) {

            $(this).find("input[type=date]").on('input', function (e) {

                var day = new Date(e.target.value).getUTCDay();

                // Days in JS range from 0-6 where 0 is Sunday and 6 is Saturday
                if (day == 0) {

                    e.target.setCustomValidity('OH NOES! We hate Sundays! Please pick any day but the Weekend.');
                    e.target.title = 'OH NOES! We hate Sundays! Please pick any day but the Weekend.';
                    e.target.parentNode.classList.add('has-error');
                } else if (day == 6) {

                    e.target.setCustomValidity('OH NOES! We hate Saturdays! Please pick any day but the Weekend.');
                    e.target.title = 'OH NOES! We hate Saturdays! Please pick any day but the Weekend.';
                    e.target.parentNode.classList.add('has-error');
                } else {

                    e.target.setCustomValidity('');
                    e.target.title = '';
                    e.target.parentNode.classList.remove('has-error');
                }

            });

            /* Binding */
            /* Fires where the user deletes a goal */
            $(this).find("a i.deleteGoal").on("click", function (e) {

                if ($(e.target).hasClass('deleteGoal')) {
                    e.stopPropagation();

                    var answer = confirm('Are you sure you want to delete this student service?');
                    if (answer) {
                        $(e.target).parentsUntil(".oneStudentService").remove();
                    }
                }

            });

            $(this).find(".number-spinner button").on("click", function () {

                var btn = $(this),
                    oldValue = btn.closest('.number-spinner').find('input').val().trim(),
                    newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < 5) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.number-spinner').find('input').val(newValue);
            });

            $(this).find(".minute-spinner button").on("click", function () {

                var btn = $(this),
                    oldValue = btn.closest('.minute-spinner').find('input').val().trim(),
                    newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < 720) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.minute-spinner').find('input').val(newValue);
            });

            $(this).find(".addServiceGoal").on("click", function () {

                var selectGoal = $(this).prev('select');
                var selectGoalSelectedTitle = $(selectGoal).find("option:selected").data('title');
                var selectGoalSelectedId = $(selectGoal).find("option:selected").attr('value');

                var goalCount = $(".serviceStudentGoal").length + 1;
                if (selectGoalSelectedId != -1) {
                    $('option:selected', selectGoal).remove();

                    var attachGoal = '<div class="panel panel-info autocollapse serviceStudentGoal" style="margin: 5px 0" data-id="' + selectGoalSelectedId + '" data-title="' + selectGoalSelectedTitle + '"><div class="panel-heading clickable"><h3 class="panel-title"><i class="fa fa-trophy"></i>&nbsp;' + selectGoalSelectedTitle + '<i class="pull-right glyphicon glyphicon-remove deletegoal"></i><input type="hidden" name="studentServiceGoal' + goalCount + '" value="' + selectGoalSelectedId + '" /></h3></div></div>';
                    $(this).closest(".row").next(".row").find(".StudentGoals").append(attachGoal);

                    initGoalEvents();
                }
            });

        });
    }
    initService();

    function initGoalEvents() {

        $('.oneStudentService').not('#defaultStudentService').each(function (index) {

            /* Binding */
            /* Fires where the user deletes a goal */
            $(this).find(".serviceStudentGoal i.deletegoal").not('.bound').addClass('bound').on("click", function (e) {

                var answer = confirm('Are you sure you want to delete this student service?');
                if (answer) {

                    var thisStudentGoal = $(e.target).closest('.serviceStudentGoal');
                    var studentGoalText = $(thisStudentGoal).data('title');
                    var studentGoalId = $(thisStudentGoal).data('id');

                    $(e.target).closest(".oneStudentService ").find("#studentGoalsSelect").append('<option value="' + studentGoalId + '" data-title="' + studentGoalText + '">' + studentGoalText + '</option>');
                    $(e.target).parentsUntil(".StudentGoals").remove();
                }
            });
        });
    }
    initGoalEvents();

</script>
