@model GreenBushIEP.Models.MISDistricContactViewModel

<style>
    .col-form-label {
        margin-top: 15px;
        font-size: 16px;
    }
</style>

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove-circle" style="font-size: 30px;"></span></button>
    <h4 class="modal-title" style="font-size: 30px;"><i class="glyphicon glyphicon-option-vertical" aria-hidden="true" style="font-size: smaller; "></i>&nbsp;District Contacts</h4>
</div>
<div class="modal-body">
    <div class="container-fluid">
        <div class="row">
            <div class="form-group col-md-6" style="padding-left: 0;">
                <label for="validate-text">Choose a Districts</label>
                <div class="input-group">
                    <span class="input-group-addon danger"><span class="glyphicon glyphicon-option-vertical"></span></span>
                    <select class="form-control" name="selectedDistrict" id="selectedDistrict" required>
                        @foreach (var district in Model.myDistricts)
                        {
                            string Selected = Model.myDistricts.IndexOf(district) == 0 ? "Selected" : string.Empty;
                            <option value="@(district.USD)" @Selected>@(district.DistrictName)</option>
                        }
                    </select>
                </div>
            </div>
        </div>
        <div class="row alert alert-danger" role="alert" id="alertMessage" style="display: none; margin-top: 20px;">
            <button type="button" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <span class="moreinfo"><strong>Results!</strong> </span>
        </div>
        <div class="row">
            <h3>District Contact</h3>
        </div>
        <div class="row" style="margin-top: 8px;">
            <div class="col-md-12" style="padding-right: 0; padding-left: 0;">
                <!-- form user info -->
                <form class="form" role="form" autocomplete="off">
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label">First name</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text" value="Jane">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label">Last name</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text" value="Bishop">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label">Email</label>
                        <div class="col-md-10">
                            <input class="form-control" type="email" value="email@gmail.com">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label">Address 1</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text" value="">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label">Address 2</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text" value="janeuser">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label">State</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text" value="janeuser">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label">Zip Code</label>
                        <div class="col-md-10">
                            <input class="form-control" type="text" value="janeuser">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-md-2 col-form-label form-control-label"></label>
                        <div class="col-md-10">
                            <input type="reset" class="btn btn-secondary" value="Cancel">&nbsp;&nbsp;
                            <input type="button" class="btn btn-primary" value="Save Changes">
                        </div>
                    </div>
                </form>
                <!-- /form user info -->
            </div>
        </div>
    </div>
    <div class="ajax-loader" style="visibility: hidden;">
        <img src="/Content/Images/loading-icon.gif" class="img-responsive" alt="updating contacts">
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="formbtn btn btn-secondary btn-lg" data-dismiss="modal"><i class="glyphicon glyphicon-remove-circle"></i>&nbsp;Close</button>
</div>

<script>
    $(function () {
        init();

        // event fired if the user selects a different option in the select
        $('#selectedDistrict').on('change', function (event) {

            $('.ajax-loader').css("visibility", "visible");
            $(".ajax-loader img").css("visibility", "visible");

            var districtUSD = $("#selectedDistrict option:selected").val();

            $.ajax({
                type: 'POST',
                url: '/Manage/ContactsInDistricts',
                dataType: 'json',
                data: { USD: districtUSD },
                async: false,
                success: function (data) {
                    $('.ajax-loader').css("visibility", "hidden");
                    $(".ajax-loader img").css("visibility", "hidden");

                    if (data.Result == "success") {

                        // clear the ul li elements.
                        $('ul.list-group').empty();

                        // foreach contact, add them the ul
                        data.Message.forEach(function (value, index) {
                            var isOpen = (value.isContact) ? "open" : "";
                            $('ul.list-group').append('<li class="list-group-item ' + isOpen + '" data-contactId="' + value.UserId + '">' + value.FirstName + ' ' + value.LastName + '<span class="show-menu"><span class="glyphicon glyphicon-chevron-right"></span></span><ul class="list-group-submenu"><li class="list-group-submenu-item success">District Contact</li></ul></li>');
                        });

                        // fire off the event handlers.
                        init();
                    }
                    else {
                        $('ul.list-group').empty();

                        $("#alertMessage").toggleClass("alert-success alert-danger");
                        $("#alertMessage .moreinfo").html(data.Message);
                        $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                            $("#alertMessage").slideUp(500);
                        });
                    }
                },
                error: function (data) {
                    $('.ajax-loader').css("visibility", "hidden");
                    $(".ajax-loader img").css("visibility", "hidden");

                    $("#alertMessage").toggleClass("alert-success alert-danger");
                    $("#alertMessage .moreinfo").html('There was an error connecting to the server.');
                    $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                        $("#alertMessage").slideUp(500);
                    });
                }
            });
        });
    });

    // hooks up all the events
    function init() {

        if ($('.list-group-item').length > 0) {

            $('.list-group-item > .show-menu').on('click', function (event) {

                event.preventDefault();
                var toggleElem = $(this).closest('li').toggleClass('open');

                // close other opened li
                $('.list-group-item').not(toggleElem).each(function () {
                    if ($(this).closest('li').hasClass('open')) {
                        otherContact = $(this);
                        $(this).removeClass('open');
                    }
                });

                $('.ajax-loader').css("visibility", "visible");
                $(".ajax-loader img").css("visibility", "visible");

                var districtUSD = $("#selectedDistrict option:selected").val();
                var contactId = $(toggleElem).data('contactid');
                var isContact = toggleElem.hasClass('open');

                $.ajax({
                    type: 'POST',
                    url: '/Manage/AddDistrictContact',
                    dataType: 'json',
                    data: { USD: districtUSD, contactId: contactId, isContact: isContact },
                    async: false,
                    success: function (data) {
                        $('.ajax-loader').css("visibility", "hidden");
                        $(".ajax-loader img").css("visibility", "hidden");

                        if (data.Result !== "success") {
                            toggleElem.removeClass('open');

                            if (otherContact != null) {
                                otherContact.addClass('open');
                            }
                        }

                        $("#alertMessage").removeClass("alert-danger");
                        $("#alertMessage").addClass(" alert-success");
                        $("#alertMessage .moreinfo").html(data.Message);
                        $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                            $("#alertMessage").slideUp(500);
                        });
                    },
                    error: function (data) {
                        $('.ajax-loader').css("visibility", "hidden");
                        $(".ajax-loader img").css("visibility", "hidden");

                        $("#alertMessage").toggleClass("alert-success alert-danger");
                        $("#alertMessage .moreinfo").html('Unknown error occured while attempting to connect with the server.');
                        $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                            $("#alertMessage").slideUp(500);
                        });
                    }
                });
            });
        }
    }
</script>