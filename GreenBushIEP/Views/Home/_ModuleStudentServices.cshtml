@using GreenBushIEP.Models
@model StudentServiceViewModel

<style>
    .form-inline .form-group {
        margin-right: 10px;
    }

    .well-primary {
        color: rgb(255, 255, 255);
        background-color: rgb(66, 139, 202);
        border-color: rgb(53, 126, 189);
    }

    .panel-group {
        margin-bottom: 12px;
    }

    .duplication-loader {
        visibility: hidden;
        background-color: rgba(255,255,255,0.7);
        position: absolute;
        z-index: 100 !important;
        width: 108%;
        height: 100%;
        top: 0;
        left: 0px;
        right: 0;
    }

        .duplication-loader img {
            position: fixed; /* or absolute */
            top: 45%;
            left: 40%;
        }
</style>

<link href="/Content/chosen.css" rel="stylesheet" />

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove-circle" style="font-size: 30px;"></span></button>
    <button type="button" class="tooltip-help" data-toggle="tooltip" data-placement="bottom" title="Follow the tooltips to learn how to user this form"><span class="glyphicon glyphicon-question-sign" style="font-size: 30px;"></span></button>
    <h4 class="modal-title" style="font-size: 30px;">
        <i class="fa fa-handshake-o" aria-hidden="true" style="font-size: smaller; "></i>&nbsp;Student Services
    </h4>
</div>
<div class="modal-body">

    <div class="container serviceContainer">
        <div class="row">
            <div class="col-md-12" style="margin-bottom: 12px;">
                <button id="newService" class="btn btn-default">New Student Service&nbsp;&nbsp;<i class="glyphicon glyphicon-plus"></i></button>
                <button id="duplicateService" class="btn btn-default">Duplicate Student Service For Next Year&nbsp;&nbsp;<i class="glyphicon glyphicon-plus"></i></button>
            </div>
        </div>
        <input type="hidden" value="@Model.IEPStartDate.ToString("yyyy-MM-dd")" id="iepStartDate" />
        <input type="hidden" value="@Model.IEPEndDate.ToString("yyyy-MM-dd")" id="iepEndDate" />


        <div class="alert alert-danger" id="alertMessage" role="alert" style="display: none;">
            <strong class="moreinfo">Oh snap!</strong>
        </div>

        <div class="row oneStudentService hidden" id="defaultStudentService">

            <div class="col-md-12">
                <div class="panel-group" id="accordion[0]">

                    <form action="/Home/saveStudentService" method="post">
                        <input type="hidden" name="StudentId" value="@Model.studentId" />
                        <input type="hidden" name="StudentSerivceId" value="0" />
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a data-toggle="collapse" data-parent="#accordion[0]" href="#collapse0">
                                        <span class="studentGoalLabel" style="margin-left:5px;">Student Service</span>
                                        <span class="pull-right">
                                            <i class="glyphicon glyphicon-trash deleteService"></i>
                                        </span>
                                    </a>
                                </h4>
                            </div>
                            <div id="collapse0" class="collapse in">
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-2">
                                            <label for="fiscalYear">Fiscal Year</label>
                                            <div class="form-group">
                                                <select class="form-control" name="fiscalYear" style="border-color: #ccc; display: inline-block;">
                                                    <option value="2018">2017 - 2018</option>
                                                    <option value="2019">2018 - 2019</option>
                                                    <option value="2020">2019 - 2020</option>
                                                    <option value="2021">2020 - 2021</option>
                                                    <option value="2022">2021 - 2022</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="Frequency">Initiation Date</label>
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                                                <input id="serviceStartDate" name="serviceStartDate" title="" type="date" class="form-control" aria-describedby="basic-addon1" value="@(Model.IEPStartDate.ToString("yyyy-MM-dd"))">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="Frequency">End Date</label>
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                                                <input id="serviceEndDate" name="serviceEndDate" title="" type="date" class="form-control" aria-describedby="basic-addon1" value="@(Model.IEPEndDate.ToString("yyyy-MM-dd"))">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="Location">Location</label>
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="glyphicon glyphicon-home"></i></span>
                                                <div class="form-group">
                                                    <select class="form-control" name="Location" style="border-color: #ccc; display: inline-block;">
                                                        @if (Model.serviceLocations.Count > 0)
                                                        {
                                                            foreach (var serviceLocation in Model.serviceLocations)
                                                            {
                                                                <option value="@serviceLocation.LocationCode">(@serviceLocation.LocationCode) @serviceLocation.Name</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <label for="Frequency">Frequency</label>
                                            <select class="form-control" name="Frequency" style="border-color: #ccc; display: inline-block;">
                                                <option value="1">Every week (1)</option>
                                                <option value="2">Every 2 weeks (2)</option>
                                                <option value="3">Every 3 weeks (3)</option>
                                                <option value="4">Every 4 weeks (4)</option>
                                                <option value="8">Every 8 weeks (8)</option>
                                                <option value="9">Every 9 weeks (9)</option>
                                                <option value="12">Every 12 weeks (12)</option>
                                                <option value="18">Every 18 weeks (18)</option>
                                                <option value="19">3 out of 4 weeks (19)</option>
                                                <option value="99">1 day per year (99)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="Days">Days per Week</label>
                                            <div class="input-group number-spinner">
                                                <span class="input-group-btn">
                                                    <button type="button" class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                </span>
                                                <input type="number" name="serviceDaysPerWeek" class="form-control text-center" value="1" min="1" max="5">
                                                <span class="input-group-btn">
                                                    <button type="button" class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="Duration">Minutes per Day </label>
                                            <div class="input-group minute-spinner">
                                                <span class="input-group-btn">
                                                    <button type="button" class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                </span>
                                                <input type="number" name="serviceMinutesPerDay" class="form-control text-center" value="1" min="1" max="60">
                                                <span class="input-group-btn">
                                                    <button type="button" class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="ServiceType">Service Type</label>
                                            <div class="form-group">
                                                <select class="form-control" name="ServiceType" style="border-color: #ccc; display: inline-block;">
                                                    @if (Model.serviceTypes.Count > 0)
                                                    {
                                                        foreach (var serviceType in Model.serviceTypes)
                                                        {
                                                            <option value="@serviceType.ServiceCode">(@serviceType.ServiceCode) @serviceType.Name</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="serviceProvider">Provider</label>
                                            <div class="form-group">
                                                <select class="form-control" name="serviceProvider" style="border-color: #ccc; display: inline-block;">
                                                    <option value="-1">-- No providers currently available --</option>
                                                    @if (Model.serviceProviders.Count > 0)
                                                    {
                                                        foreach (var serviceProvider in Model.serviceProviders)
                                                        {
                                                            <option value="@serviceProvider.ProviderID">@serviceProvider.Name</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label>Attach a Goal</label>
                                            <div class="input-group">
                                                <span class="input-group-addon"><i class="glyphicon glyphicon-paperclip"></i></span>
                                                <select class="form-control chosen-select" data-placeholder="Choose a goal..." id="studentGoalsSelect" multiple="multiple" data-validate="true">
                                                    @if (Model.studentGoals.Count > 0)
                                                    {
                                                        foreach (var goal in Model.studentGoals)
                                                        {
                                                            <option value="@goal.goalID" data-title="@goal.Title.ToString()">@goal.Title.ToString()</option>
                                                        }
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <br />
                                        <div class="col-md-12" style="text-align:center;">
                                            <button type="reset" class="btn btn-default">Reset</button>
                                            <button type="button" class="saveService btn btn-primary">Save</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>

        @foreach (var service in Model.studentServices)
        {
            <div class="row oneStudentService">
                <div class="col-md-12">
                    <div class="panel-group" id="accordion[@service.ServiceID]">

                        <form action="/Home/saveStudentService" method="post">
                            <input type="hidden" name="StudentId" value="@Model.studentId" />
                            <input type="hidden" name="StudentSerivceId" value="@(service.ServiceID)" />
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#accordion[@service.ServiceID]" href="#collapse@(service.ServiceID)">
                                            <span class="studentGoalLabel" style="margin-left:5px;">Student Service</span>
                                            <span class="pull-right">
                                                <i class="glyphicon glyphicon-trash deleteService"></i>
                                            </span>
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapse@(service.ServiceID)" class="collapse in">
                                    <div class="panel-body">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label for="fiscalYear">Fiscal Year</label>
                                                <div class="form-group">
                                                    <select class="form-control" name="fiscalYear" style="border-color: #ccc; display: inline-block;">
                                                        <option value="2018" @(service.SchoolYear == 2018 ? "selected" : "")>2017 - 2018</option>
                                                        <option value="2019" @(service.SchoolYear == 2019 ? "selected" : "")>2018 - 2019</option>
                                                        <option value="2020" @(service.SchoolYear == 2020 ? "selected" : "")>2019 - 2020</option>
                                                        <option value="2021" @(service.SchoolYear == 2021 ? "selected" : "")>2020 - 2021</option>
                                                        <option value="2022" @(service.SchoolYear == 2022 ? "selected" : "")>2021 - 2022</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="Frequency">Initiation Date</label>
                                                <div class="input-group">
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                                                    <input id="serviceStartDate" name="serviceStartDate" title="" type="date" class="form-control" aria-describedby="basic-addon1" value="@(service.StartDate.ToString("yyyy-MM-dd"))">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="Frequency">End Date</label>
                                                <div class="input-group">
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                                                    <input id="serviceEndDate" name="serviceEndDate" title="" type="date" class="form-control" aria-describedby="basic-addon1" value="@(service.EndDate.ToString("yyyy-MM-dd"))">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="Location">Location</label>
                                                <div class="input-group">
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-home"></i></span>
                                                    <div class="form-group">
                                                        <select class="form-control" name="Location" style="border-color: #ccc; display: inline-block;">
                                                            @if (Model.serviceLocations.Count > 0)
                                                            {
                                                                foreach (var serviceLocation in Model.serviceLocations)
                                                                {
                                                                    <option value="@serviceLocation.LocationCode" @(service.LocationCode == serviceLocation.LocationCode ? "selected" : "")>(@serviceLocation.LocationCode) @serviceLocation.Name</option>
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-2">
                                                <label for="Frequency">Frequency</label>
                                                <div class="input-group">
                                                    <div class="form-group">
                                                        <select class="form-control" name="Frequency" style="border-color: #ccc; display: inline-block;">
                                                            <option value="1" @(service.Frequency == 1 ? "selected" : "")>Every week (1)</option>
                                                            <option value="2" @(service.Frequency == 2 ? "selected" : "")>Every 2 weeks (2)</option>
                                                            <option value="3" @(service.Frequency == 3 ? "selected" : "")>Every 3 weeks (3)</option>
                                                            <option value="4" @(service.Frequency == 4 ? "selected" : "")>Every 4 weeks (4)</option>
                                                            <option value="8" @(service.Frequency == 8 ? "selected" : "")>Every 8 weeks (8)</option>
                                                            <option value="9" @(service.Frequency == 9 ? "selected" : "")>Every 9 weeks (9)</option>
                                                            <option value="12" @(service.Frequency == 12 ? "selected" : "")>Every 12 weeks (12)</option>
                                                            <option value="18" @(service.Frequency == 18 ? "selected" : "")>Every 18 weeks (18)</option>
                                                            <option value="19" @(service.Frequency == 19 ? "selected" : "")>3 out of 4 weeks (19)</option>
                                                            <option value="99" @(service.Frequency == 99 ? "selected" : "")>1 day per year (99)</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="Days">Days per Week</label>
                                                <div class="input-group number-spinner">
                                                    <span class="input-group-btn">
                                                        <button type="button" class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                    </span>
                                                    <input type="number" name="serviceDaysPerWeek" class="form-control text-center" value="@(service.DaysPerWeek)" min="1" max="5">
                                                    <span class="input-group-btn">
                                                        <button type="button" class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <label for="Duration">Minutes per Day </label>
                                                <div class="input-group minute-spinner">
                                                    <span class="input-group-btn">
                                                        <button type="button" class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                    </span>
                                                    <input type="number" name="serviceMinutesPerDay" class="form-control text-center" value="@(service.Minutes)" min="1" max="60">
                                                    <span class="input-group-btn">
                                                        <button type="button" class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="ServiceType">Service Type</label>
                                                <div class="form-group">
                                                    <select class="form-control" name="ServiceType" style="border-color: #ccc; display: inline-block;">
                                                        @if (Model.serviceTypes.Count > 0)
                                                        {
                                                            foreach (var serviceType in Model.serviceTypes)
                                                            {
                                                                <option value="@serviceType.ServiceCode" @(service.ServiceCode == serviceType.ServiceCode ? "selected" : "")>(@serviceType.ServiceCode) @serviceType.Name</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="serviceProvider">Provider</label>
                                                <div class="form-group">
                                                    <select class="form-control" name="serviceProvider" style="border-color: #ccc; display: inline-block;">
                                                        <option value="-1">-- No providers currently available --</option>
                                                        @if (Model.serviceProviders.Count > 0)
                                                        {
                                                            foreach (var serviceProvider in Model.serviceProviders)
                                                            {
                                                                <option value="@serviceProvider.ProviderID" @(service.ProviderID == serviceProvider.ProviderID ? "selected" : "")>@serviceProvider.Name</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label>Attach a Goal</label>
                                                <div class="input-group">
                                                    <span class="input-group-addon"><i class="glyphicon glyphicon-paperclip"></i></span>
                                                    <select id="studentGoalsSelect" name="studentGoalsSelect" class="form-control chosen-select" data-placeholder="Choose a goal..." multiple="multiple" data-validate="true">
                                                        @if (Model.studentGoals.Count > 0)
                                                        {
                                                            foreach (var goal in Model.studentGoals)
                                                            {
                                                                string selectString = String.Empty;
                                                                selectString = service.tblGoals.Contains(goal) ? "selected" : String.Empty;

                                                                <option value="@goal.goalID" data-title="@goal.Title.ToString()" @selectString>@goal.Title.ToString()</option>
                                                            }
                                                        }
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <br />
                                            <div class="col-md-12" style="text-align:center;">
                                                <button type="reset" class="btn btn-default">Reset</button>
                                                <button type="button" class="saveService btn btn-primary">Save</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                        </form>

                    </div>
                </div>
            </div>
        }

    </div>

    <div class="duplication-loader">
        <img src="~/Content/Images/copying-icon.gif" class="img-responsive" alt="copying services.." />
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">Close</button>
</div>

<script>
    $('#serviceStartDate').prop('min', function () { return new Date().toJSON().split('T')[0]; });
    $('#serviceEndDate').prop('min', function () { return new Date().toJSON().split('T')[0]; });
    //$(".chosen-select").chosen({ width: "100%" });

    var model = '@Html.Raw(Json.Encode(Model.calendar))';
    var calendarArrayOfDates = JSON.parse(model);

    var availableCalendarDays = '@Html.Raw(Json.Encode(Model.availableCalendarDays))';
    var availableCalendarDaysArray = JSON.parse(availableCalendarDays);

    var Reports = '@Html.Raw(Json.Encode(Model.calendarReportings))';
    var calendarReportsArray = JSON.parse(Reports);

    /* Binding */
    /* tooltips */
    $('[data-toggle="tooltip"]').tooltip({
        trigger: 'manual'
    });

    //duplicate service for next school year
    $('#duplicateService').on('click', function () {
        $(".duplication-loader").css('visibility', 'visible');

        var fiscalYears = $('[name="fiscalYear"]');
        var dupFiscalYear;
        var dupServiceDaysPerWeek = 0;
        var dupserviceMinutesPerDay = 0;
        var dupFrequency = 0;
        var dupLocation = '';
        var dupServiceType = '';
        var dupServiceProvider = '';

        if (fiscalYears.length > 0)
            dupFiscalYear = fiscalYears.last().val();

        var serviceDaysPerWeeks = $('[name="serviceDaysPerWeek"]');
        if (serviceDaysPerWeeks.length > 0)
            dupServiceDaysPerWeek = serviceDaysPerWeeks.last().val();


        var serviceMinutesPerDays = $('[name="serviceMinutesPerDay"]');
        if (serviceMinutesPerDays.length > 0)
            dupserviceMinutesPerDay = serviceMinutesPerDays.last().val();

        var Frequencys = $('[name="Frequency"]');
        if (Frequencys.length > 0)
            dupFrequency = Frequencys.find(":selected").last().val();

        var Locations = $('[name="Location"]');
        if (Locations.length > 0)
            dupLocation = Locations.last().find(":selected").val();

        var ServiceTypes = $('[name="ServiceType"]');
        if (ServiceTypes.length > 0)
            dupServiceType = ServiceTypes.last().find(":selected").val();

        var serviceProviders = $('[name="serviceProvider"]');
        if (serviceProviders.length > 0)
            dupServiceProvider = serviceProviders.last().find(":selected").val();

        duplicateService(dupFiscalYear, dupServiceDaysPerWeek, dupFrequency, dupLocation, dupServiceType, dupServiceProvider, dupserviceMinutesPerDay);

    });

    /* Event */
    /* When a user clicks on the question mark icon we turn on tooltips */
    $('.tooltip-help').on('click', function () {
        $('[data-toggle="tooltip"]').tooltip('toggle');
    });

    /* Event */
    /* when clicking on the New Student Goal button */
    $('#newService').on('click', function () {
        $.each($("div.collapse"), function (index) {
            $(this).collapse('hide');
        });

        var cloneService = $("#defaultStudentService").clone();
        cloneService.removeClass("hidden");
        cloneService.removeAttr("id");

        // count the number of services and increment our counter in the accordian view.
        var serviceCount = $('.oneStudentService').not("#defaultStudentService").length + 1;
        cloneService.children().children().prop("id", "accordion[" + serviceCount + "]");

        // set up the accordian click event.
        var serviceA = cloneService.find('[data-parent="#accordion[0]"]').attr('data-parent', '#accordion[' + serviceCount + ']');
        serviceA.attr('href', '#collapse' + serviceCount);

        var panelCollapse = cloneService.find("#collapse0").prop("id", "collapse" + serviceCount);

        $('.serviceContainer').append(cloneService);

        panelCollapse.collapse('show');

        initService();
    });

    function initService() {
        $('.oneStudentService').not('#defaultStudentService').not('.bound').addClass('bound').each(function (index) {

            $(this).find("select[name='fiscalYear']").on("change", function (e) {
                var year = $(this).val();

                for (var i = 0; i < calendarReportsArray.length; i++) {
                    if (calendarReportsArray[i].SchoolYear == year) {
                        var serviceDaysPerWeek = $(this).closest(".row").find("input[name='serviceDaysPerWeek']");
                        var serviceMinutesPerDay = $(this).closest(".row").find("input[name='serviceMinutesPerDay']");

                        serviceDaysPerWeek.prop("max", calendarReportsArray[i].DaysPerWeek);
                        if (serviceDaysPerWeek.val() > calendarReportsArray[i].DaysPerWeek) { serviceDaysPerWeek.prop("value", calendarReportsArray[i].DaysPerWeek); }
                        serviceMinutesPerDay.prop("max", calendarReportsArray[i].MinutesPerDay);
                        if (serviceMinutesPerDay.val() > calendarReportsArray[i].MinutesPerDay) { serviceMinutesPerDay.prop("value", calendarReportsArray[i].MinutesPerDay); }
                    }
                }
                //check end data when fiscal year changed
                var endDateElement = $(this).closest(".row").find("input[name='serviceEndDate']");
                getEndOfSchoolYear(endDateElement, defaultYear, "iepEndDate", 6);
            });

            $(this).find("input[type=date]").on('input', function (e) {
                if (e.target.value == '') {
                    e.target.setCustomValidity('You must enter a calendar date');
                    e.target.title = 'You must enter a calendar date';
                    e.target.parentNode.classList.add('has-error');

                    return;
                }

                var day = new Date(e.target.value).getUTCDay();
                var calendaryDay = e.target.value.split('-');

                // Days in JS range from 0-6 where 0 is Sunday and 6 is Saturday
                if (day == 0) {
                    e.target.setCustomValidity('OH NOES! We hate Sundays! Please pick any day but the Weekend.');
                    e.target.title = 'OH NOES! We hate Sundays! Please pick any day but the Weekend.';
                    e.target.parentNode.classList.add('has-error');
                } else if (day == 6) {
                    e.target.setCustomValidity('OH NOES! We hate Saturdays! Please pick any day but the Weekend.');
                    e.target.title = 'OH NOES! We hate Saturdays! Please pick any day but the Weekend.';
                    e.target.parentNode.classList.add('has-error');
                } else if (isNoServiceDay(calendaryDay[0], calendaryDay[1], calendaryDay[2])) {
                    e.target.setCustomValidity('OH NOES! That is day is not is session.');
                    e.target.title = 'OH NOES! That is day is not is session.';
                    e.target.parentNode.classList.add('has-error');
                } else if (e.target.value < $('#iepStartDate').val() || e.target.value > $('#iepEndDate').val()) {
                    e.target.setCustomValidity('OH NOES! That not in range of the IEP.');
                    e.target.title = 'OH NOES! That not in range of the IEP.';
                    e.target.parentNode.classList.add('has-error');
                }
                else {
                    e.target.setCustomValidity('');
                    e.target.title = '';
                    e.target.parentNode.classList.remove('has-error');
                }

            });

            $(this).find("a i.deleteService").on("click", function (e) {

                if ($(e.target).hasClass('deleteService')) {
                    e.stopPropagation();

                    var answer = confirm('Are you sure you want to delete this student service?');
                    var oneStudentService = $(e.target);
                    var studentServiceId = $(e.target).closest('form').find("input[name=StudentSerivceId]").val();
                    var alertBox = $(this).closest('.oneStudentService').prev();

                    if (answer) {
                        if (studentServiceId != 0) {
                            $.ajax({
                                type: 'POST',
                                url: '/Home/DeleteStudentService',
                                data: { studentServiceId: studentServiceId },
                                dataType: "json",
                                success: function (data) {
                                    if (data.Result == "success") {
                                        var previousService = $(this).closest(".oneStudentService").prev(".oneStudentService:visible").find(".collapse");
                                        oneStudentService.parentsUntil(".oneStudentService").parent().remove();
                                        previousService.collapse('show');

                                        $("#alertMessage .moreinfo").html('Student Service successfully deleted.');
                                        $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                            $("#alertMessage").slideUp(500);
                                        });
                                    }
                                    else {
                                        if ($("#alertMessage").css('display') && $("#alertMessage").css('display') === 'none') {
                                            $("#alertMessage .moreinfo").html(data.Message);
                                            $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                                $("#alertMessage").slideUp(500);
                                            });
                                        }
                                    }
                                },
                                error: function (data) {
                                    console.log("Unable to delete the student goal.");
                                }
                            });
                        }
                        else {
                            var previousService = $(this).closest(".oneStudentService").prev(".oneStudentService:visible").find(".collapse");
                            oneStudentService.parentsUntil(".oneStudentService").parent().remove();
                            previousService.collapse('show');
                        }
                    }
                }

            });

            $(this).find(".number-spinner button").on("click", function () {

                var btn = $(this),
                   oldValue = btn.closest('.number-spinner').find('input').val().trim(),
                   newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < 5) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.number-spinner').find('input').val(newValue);
            });

            $(this).find("input[name='serviceDaysPerWeek']").on("change", function () {

                var min = $(this).attr("min");
                var max = $(this).attr("max");
                var number = $(this).val();

                if (number > max) {
                    $(this).val(5);
                }
                else {
                    $(this).val(1);
                }
            });

            $(this).find(".minute-spinner button").on("click", function () {

                var btn = $(this),
                    maxValue = btn.closest('.minute-spinner').find('input').prop("max"),
                    oldValue = btn.closest('.minute-spinner').find('input').val().trim(),
                    newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < maxValue) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.minute-spinner').find('input').val(newValue);
            });

            $(this).find('.saveService').on("click", function () {

                var alertBox = $(this).closest('.oneStudentService').prev();
                var form = $(this).closest('.oneStudentService').find('form').serialize();

                $.ajax({
                    type: 'POST',
                    url: '/Home/SaveStudentService',
                    data: form,
                    dataType: 'json',
                    success: function (data) {
                        if (data.Result == "success") {
                            $("#alertMessage .moreinfo").html(data.Message);
                            $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                $("#alertMessage").slideUp(500);
                            });
                        }
                        else {
                            $("#alertMessage .moreinfo").html('Unable to save the Student Service. Try again later.');
                            $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                $("#alertMessage").slideUp(500);
                            });
                        }
                    },
                    error: function (data) {
                        $("#alertMessage .moreinfo").html('Unable to connect to the database.');
                        $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                            $("#alertMessage").slideUp(500);
                        });
                    }
                });
            });

            /* Closes all the other panel groups except the one you clicked on */
            $(this).find(".panel-title a").on("click", function () {
                $(".collapse").each(function () {
                    $(this).collapse('hide');
                });
            });

            $(this).find('.chosen-select').chosen({ width: "100%" });

            //setup end date
            var endDateElement = $(this).closest(".row").find("input[name='serviceEndDate']");
            var defaultYear = $(this).find("select[name='fiscalYear']").val();
            var iepEndDate = $("#iepEndDate").val();

            //if using iep end date as default, try to find the end of the selected school year
            if (endDateElement.val() == iepEndDate)
                getEndOfSchoolYear(endDateElement, defaultYear, "iepEndDate", 6);

            var is_safari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            var is_explorer = typeof document !== 'undefined' && !!document.documentMode && !isEdge;
            if (is_safari || is_explorer) {
                $("#serviceStartDate").datepicker();
                $("#serviceEndDate").datepicker();
            }
        });
    }
    initService();

    function initGoalEvents() {

        $('.oneStudentService').not('#defaultStudentService').each(function (index) {

            /* Binding */
            /* Fires where the user deletes a goal */
            $(this).find(".serviceStudentGoal i.deletegoal").not('.bound').addClass('bound').on("click", function (e) {

                var answer = confirm('Are you sure you want to remove the attached goal from this student service?');
                if (answer) {

                    var thisStudentGoal = $(e.target).closest('.serviceStudentGoal');
                    var studentGoalText = $(thisStudentGoal).data('title');
                    var studentGoalId = $(thisStudentGoal).data('id');

                    $(e.target).closest(".oneStudentService ").find("#studentGoalsSelect").append('<option value="' + studentGoalId + '" data-title="' + studentGoalText + '">' + studentGoalText + '</option>');
                    $(e.target).parentsUntil(".StudentGoals").remove();
                }
            });
        });
    }
    initGoalEvents();

    function isNoServiceDay(year, month, day) {
        for (var i = 0; i < calendarArrayOfDates.length; i++) {
            if (calendarArrayOfDates[i].Day == day && calendarArrayOfDates[i].Month == month && calendarArrayOfDates[i].Year == year) {
                return true;
            }
        }

        return false;
    }

    function getEndOfSchoolYear(element, selectedYear, dateElementName, startMonth) {
        var iepDate = $('#' + dateElementName).val();
        var lastDay;
        //var startMonth = 6;

        var Month = 0;
        var Day = 0;
        var Year = 0;

        var iepEndMonth = 0;
        var iepEndDay = 0;
        var iepEndYear = 0;
        var iepEndDateArr = iepDate.split('-');

        if (iepEndDateArr.length > 0 && iepEndDateArr.length == 3) {
            iepEndYear = iepEndDateArr[0];
            iepEndMonth = iepEndDateArr[1];
            iepEndDay = iepEndDateArr[2];
        }

        var iepEDDate = new Date(iepEndYear, iepEndMonth - 1, iepEndDay);

        for (var i = startMonth; i > 0; i--) {
            Month = 0, Day = 0, Year = 0;

            var dateFound = searchLastDay(selectedYear, i)
            if (dateFound != undefined) {
                Month = dateFound.Month;
                Day = dateFound.Day;
                Year = dateFound.Year;
                var dfDate = new Date(Year, Month - 1, Day);
                if (dfDate <= iepEDDate) {
                    lastDay = dfDate;
                    break;
                }
            }
        }

        if (lastDay != undefined) {
            // Please pay attention to the month (parts[1]); JavaScript counts months from 0:
            // January - 0, February - 1, etc.
            var formattedDate = formatDate(lastDay);
            element.val(formattedDate);
        }
    }

    function searchLastDay(selectedYear, startMonth) {
        var dates = jsonPath(availableCalendarDaysArray, "$..[?(@@.SchoolYear == " + selectedYear + " && @@.Month == " + startMonth + ")]");
        if (dates.length > 0) {
            var lastItem = dates.length - 1;
            var lastDay = dates[lastItem];
            return lastDay;
        }

    }

    function searchFirstDay(selectedYear, firstYearOfFiscalYear, startMonth) {
        var dates = jsonPath(availableCalendarDaysArray, "$..[?(@@.SchoolYear == " + selectedYear + " && @@.Month == " + startMonth + " && @@.Year == " + firstYearOfFiscalYear + ")]");
        if (dates.length > 0) {
            return dates[0];
        }

    }

    function duplicateService(dupFiscalYear, dupserviceDaysPerWeek, dupFrequency, dupLocation, dupServiceType, dupserviceProvider, dupserviceMinutesPerDay) {
        $.each($("div.collapse"), function (index) {
            $(this).collapse('hide');
        });

        var nextYear = parseInt(dupFiscalYear) + 1;

        var cloneService = $("#defaultStudentService").clone();
        cloneService.removeClass("hidden");
        cloneService.removeAttr("id");

        // count the number of services and increment our counter in the accordian view.
        var serviceCount = $('.oneStudentService').not("#defaultStudentService").length + 1;
        cloneService.children().children().prop("id", "accordion[" + serviceCount + "]");

        // set up the accordian click event.
        var serviceA = cloneService.find('[data-parent="#accordion[0]"]').attr('data-parent', '#accordion[' + serviceCount + ']');
        serviceA.attr('href', '#collapse' + serviceCount);

        var panelCollapse = cloneService.find("#collapse0").prop("id", "collapse" + serviceCount);

        $('.serviceContainer').append(cloneService);

        panelCollapse.collapse("show");

        initDuplicateService(nextYear, dupserviceDaysPerWeek, dupFrequency, dupLocation, dupServiceType, dupserviceProvider, dupserviceMinutesPerDay);
    }

    function initDuplicateService(nextYear, dupserviceDaysPerWeek, dupFrequency, dupLocation, dupServiceType, dupserviceProvider, dupserviceMinutesPerDay) {
        $('.oneStudentService').not('#defaultStudentService').not('.bound').addClass('bound').each(function (index) {

            //set to next year
            $(this).find("select[name='fiscalYear']").val(nextYear);
            $(this).find("input[name='serviceDaysPerWeek']").val(dupserviceDaysPerWeek);
            $(this).find("input[name='serviceMinutesPerDay']").val(dupserviceMinutesPerDay);
            $(this).find("select[name='Frequency']").val(dupFrequency).prop('selected', true);
            $(this).find("select[name='Location']").val(dupLocation).prop('selected', true);
            $(this).find("select[name='ServiceType']").val(dupServiceType).prop('selected', true);
            $(this).find("select[name='serviceProvider']").val(dupserviceProvider).prop('selected', true);
            $(this).find('.chosen-select').chosen({ width: "100%" });

            /* Closes all the other panel groups except the one you clicked on */
            $(this).find(".panel-title a").on("click", function () {
                $(".collapse").each(function () {
                    $(this).collapse('hide');
                });
            });

            $(this).find("select[name='fiscalYear']").on("change", function (e) {
                var year = $(this).val();

                for (var i = 0; i < calendarReportsArray.length; i++) {
                    if (calendarReportsArray[i].SchoolYear == year) {
                        var serviceDaysPerWeek = $(this).closest(".row").find("input[name='serviceDaysPerWeek']");
                        var serviceMinutesPerDay = $(this).closest(".row").find("input[name='serviceMinutesPerDay']");

                        serviceDaysPerWeek.prop("max", calendarReportsArray[i].DaysPerWeek);
                        if (serviceDaysPerWeek.val() > calendarReportsArray[i].DaysPerWeek) { serviceDaysPerWeek.prop("value", calendarReportsArray[i].DaysPerWeek); }
                        serviceMinutesPerDay.prop("max", calendarReportsArray[i].MinutesPerDay);
                        if (serviceMinutesPerDay.val() > calendarReportsArray[i].MinutesPerDay) { serviceMinutesPerDay.prop("value", calendarReportsArray[i].MinutesPerDay); }
                    }
                }
                //check end data when fiscal year changed
                var endDateElement = $(this).closest(".row").find("input[name='serviceEndDate']");
                getEndOfSchoolYear(endDateElement, defaultYear, "iepEndDate", 6);
            });

            $(this).find("input[type=date]").on('input', function (e) {
                if (e.target.value == '') {
                    e.target.setCustomValidity('You must enter a calendar date');
                    e.target.title = 'You must enter a calendar date';
                    e.target.parentNode.classList.add('has-error');

                    return;
                }

                var day = new Date(e.target.value).getUTCDay();
                var calendaryDay = e.target.value.split('-');

                // Days in JS range from 0-6 where 0 is Sunday and 6 is Saturday
                if (day == 0) {
                    e.target.setCustomValidity('OH NOES! We hate Sundays! Please pick any day but the Weekend.');
                    e.target.title = 'OH NOES! We hate Sundays! Please pick any day but the Weekend.';
                    e.target.parentNode.classList.add('has-error');
                } else if (day == 6) {
                    e.target.setCustomValidity('OH NOES! We hate Saturdays! Please pick any day but the Weekend.');
                    e.target.title = 'OH NOES! We hate Saturdays! Please pick any day but the Weekend.';
                    e.target.parentNode.classList.add('has-error');
                } else if (isNoServiceDay(calendaryDay[0], calendaryDay[1], calendaryDay[2])) {
                    e.target.setCustomValidity('OH NOES! That is day is not is session.');
                    e.target.title = 'OH NOES! That is day is not is session.';
                    e.target.parentNode.classList.add('has-error');
                } else if (e.target.value < $('#iepStartDate').val() || e.target.value > $('#iepEndDate').val()) {
                    e.target.setCustomValidity('OH NOES! That not in range of the IEP.');
                    e.target.title = 'OH NOES! That not in range of the IEP.';
                    e.target.parentNode.classList.add('has-error');
                }
                else {
                    e.target.setCustomValidity('');
                    e.target.title = '';
                    e.target.parentNode.classList.remove('has-error');
                }

            });

            /* Binding */
            /* Fires where the user deletes a service */
            $(this).find("a i.deleteService").on("click", function (e) {

                if ($(e.target).hasClass('deleteService')) {
                    e.stopPropagation();

                    var answer = confirm('Are you sure you want to delete this student service?');
                    var oneStudentService = $(e.target);
                    var studentServiceId = $(e.target).closest('form').find("input[name=StudentSerivceId]").val();
                    var alertBox = $(this).closest('.oneStudentService').prev();

                    if (answer) {
                        if (studentServiceId != 0) {
                            $.ajax({
                                type: 'POST',
                                url: '/Home/DeleteStudentService',
                                data: { studentServiceId: studentServiceId },
                                dataType: "json",
                                success: function (data) {
                                    if (data.Result == "success") {
                                        var previousService = $(this).closest(".oneStudentService").prev(".oneStudentService:visible").find(".collapse");
                                        oneStudentService.parentsUntil(".oneStudentService").parent().remove();
                                        previousService.collapse('show');

                                        $("#alertMessage .moreinfo").html('Student Service successfully deleted.');
                                        $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                            $("#alertMessage").slideUp(500);
                                        });
                                    }
                                    else {
                                        if ($("#alertMessage").css('display') && $("#alertMessage").css('display') === 'none') {
                                            $("#alertMessage .moreinfo").html(data.Message);
                                            $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                                $("#alertMessage").slideUp(500);
                                            });
                                        }
                                    }
                                },
                                error: function (data) {
                                    console.log("Unable to delete the student goal.");
                                }
                            });
                        }
                        else {
                            var previousService = $(this).closest(".oneStudentService").prev(".oneStudentService:visible").find(".collapse");
                            oneStudentService.parentsUntil(".oneStudentService").parent().remove();
                            previousService.collapse('show');
                        }
                    }
                }

            });

            $(this).find(".number-spinner button").on("click", function () {

                var btn = $(this),
                   oldValue = btn.closest('.number-spinner').find('input').val().trim(),
                   newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < 5) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.number-spinner').find('input').val(newValue);
            });

            $(this).find("input[name='serviceDaysPerWeek']").on("change", function () {

                var min = $(this).attr("min");
                var max = $(this).attr("max");
                var number = $(this).val();

                if (number > max) {
                    $(this).val(5);
                }
                else {
                    $(this).val(1);
                }
            })

            $(this).find(".minute-spinner button").on("click", function () {

                var btn = $(this),
                    maxValue = btn.closest('.minute-spinner').find('input').prop("max"),
                    oldValue = btn.closest('.minute-spinner').find('input').val().trim(),
                    newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < maxValue) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.minute-spinner').find('input').val(newValue);
            });

            $(this).find(".addServiceGoal").on("click", function () {

                var selectGoal = $(this).prev('select');
                var selectGoalSelectedTitle = $(selectGoal).find("option:selected").data('title');
                var selectGoalSelectedId = $(selectGoal).find("option:selected").attr('value');

                var goalCount = $(".serviceStudentGoal").length + 1;
                if (selectGoalSelectedId != -1) {
                    $('option:selected', selectGoal).remove();

                    var attachGoal = '<div class="panel panel-info autocollapse serviceStudentGoal" style="margin: 5px 0" data-id="' + selectGoalSelectedId + '" data-title="' + selectGoalSelectedTitle + '"><div class="panel-heading clickable"><h3 class="panel-title"><i class="glyphicon glyphicon-paperclip"></i>&nbsp;&nbsp;<i class="fa fa-trophy"></i>&nbsp;' + selectGoalSelectedTitle + '<i class="pull-right glyphicon glyphicon-remove deletegoal"></i><input type="hidden" name="studentServiceGoal' + goalCount + '" value="' + selectGoalSelectedId + '" /></h3></div></div>';
                    $(this).closest(".row").next(".row").find(".StudentGoals").append(attachGoal);

                    initGoalEvents();
                }
            });

            $(this).find('.saveService').on("click", function () {

                var alertBox = $(this).closest('.oneStudentService').prev();
                var form = $(this).closest('.oneStudentService').find('form').serialize();

                $.ajax({
                    type: 'POST',
                    url: '/Home/SaveStudentService',
                    data: form,
                    dataType: 'json',
                    success: function (data) {
                        if (data.Result == "success") {
                            $("#alertMessage .moreinfo").html(data.Message);
                            $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                $("#alertMessage").slideUp(500);
                            });
                        }
                        else {
                            $("#alertMessage .moreinfo").html('Unable to save the Student Service. Try again later.');
                            $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                                $("#alertMessage").slideUp(500);
                            });
                        }
                    },
                    error: function (data) {
                        $("#alertMessage .moreinfo").html('Unable to connect to the database.');
                        $("#alertMessage").fadeTo(3000, 500).slideUp(500, function () {
                            $("#alertMessage").slideUp(500);
                        });
                    }
                });
            })

            //setup end date
            var endDateElement = $(this).closest(".row").find("input[name='serviceEndDate']");
            var iepEndDate = $("#iepEndDate").val();
            //if using iep end date as default, try to find the end of the selected school year
            if (endDateElement.val() == iepEndDate)
                getEndOfSchoolYear(endDateElement, nextYear, "iepEndDate", 6);


            //setup start date - find by first year of selected fiscal year
            var firstDayNextYear = searchFirstDay(nextYear, nextYear - 1, 8);

            var startDateElement = $(this).closest(".row").find("input[name='serviceStartDate']");
            if (firstDayNextYear != undefined) {
                var Month = firstDayNextYear.Month;
                var Day = firstDayNextYear.Day;
                var Year = firstDayNextYear.Year;
                var dfDate = new Date(Year, Month - 1, Day);
                var formattedDate = formatDate(dfDate);
                startDateElement.val(formattedDate);
            }


            $(".duplication-loader").css('visibility', 'hidden');
        });
    }

</script>
