
<style>
    .form-inline .form-group {
        margin-right: 10px;
    }

    .well-primary {
        color: rgb(255, 255, 255);
        background-color: rgb(66, 139, 202);
        border-color: rgb(53, 126, 189);
    }

    .panel-group {
        margin-bottom: 12px;
    }
</style>

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"><span class="glyphicon glyphicon-remove-circle" style="font-size: 30px;"></span></button>
    <button type="button" class="tooltip-help" data-toggle="tooltip" data-placement="bottom" title="Follow the tooltips to learn how to user this form"><span class="glyphicon glyphicon-question-sign" style="font-size: 30px;"></span></button>
    <h4 class="modal-title" style="font-size: 30px;">
        <i class="fa fa-handshake-o" aria-hidden="true" style="font-size: smaller; "></i>&nbsp;Student Services
    </h4>
</div>
<div class="modal-body">

    <div class="container goalContainer">
        <div class="row">
            <div class="col-md-12" style="margin-bottom: 12px;">
                <button id="newgoal" class="btn btn-default">New Student Service&nbsp;&nbsp;<i class="glyphicon glyphicon-plus"></i></button>
            </div>
        </div>

        <div class="row oneStudentGoal hidden" id="defaultgoal">
            <div class="col-md-12">
                <div class="panel-group" id="accordion[0]">

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" data-parent="#accordion[0]" href="#collapse0">
                                    <span class="fa fa-handshake-o"></span><span class="studentGoalLabel" style="margin-left:5px;">Student Service</span>
                                    <span class="pull-right">
                                        <i class="glyphicon glyphicon-trash deleteGoal"></i>
                                    </span>
                                </a>
                            </h4>
                        </div>
                        <div id="collapse0" class="panel-collapse collapse in">
                            <div class="panel-body">
                                <div class="row" style="background-color: #f5f5f5;">
                                    <div class="col-md-12">
                                        <div>
                                            <label for="StudentGoalTitle">Service Type</label><br />
                                            <div class="form-group">
                                                <input type="text" class="form-control studentGoalTitle" name="StudentGoalTitle" placeholder="Enter a title for this goal" required value="Service Type" />
                                            </div>
                                            <label for="StudentAnnualGoal" data-toggle="tooltip" data-placement="right" title="Enter a long term goal you would like the student to achieve.">Service Description</label><br />
                                            <div class="form-group">
                                                <textarea class="form-control" name="StudentAnnualGoal" placeholder="Provide more information about this service." rows="5" required></textarea>
                                            </div>
                                            <label for="serviceStartDate">Service Start Date</label>
                                            <div class="form-group">
                                                <input name="serviceStartDate" type="date" vale="" style="box-shadow: none; height: 49px; padding: 6px 12px; font-size: 14px;" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="row" style="margin-top: 35px;">
                                            <div class="col-md-12">
                                                <div class="form-group col-md-4" name="Frequency" style="padding-left: 0;">
                                                    <label for="Frequency">Frequency <span style="font-size: 8pt; font-weight: normal;">(Days per Week)</span></label>
                                                    <div class="input-group number-spinner">
                                                        <span class="input-group-btn">
                                                            <button class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                        </span>
                                                        <input type="text" class="form-control text-center" value="1">
                                                        <span class="input-group-btn">
                                                            <button class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="form-group col-md-4" name="Duration">
                                                    <label for="Duration">Duration <span style="font-size: 8pt; font-weight: normal;">(Minutes per Day)</span></label>
                                                    <div class="input-group minute-spinner">
                                                        <span class="input-group-btn">
                                                            <button class="btn btn-default" data-dir="dwn" style="height: 49px;"><span class="glyphicon glyphicon-minus"></span></button>
                                                        </span>
                                                        <input type="text" class="form-control text-center" value="1">
                                                        <span class="input-group-btn">
                                                            <button class="btn btn-default" data-dir="up" style="height: 49px;"><span class="glyphicon glyphicon-plus"></span></button>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="form-group col-md-4" name="Location">
                                                    <label for="Location">Location</label><br />
                                                    <div class="form-group">
                                                        <input type="text" class="form-control" name="ServiceLocation" required value="" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <label for="ServiceComment">Comments</label>
                                        <div class="form-group">
                                            <textarea class="form-control" name="ServiceComment" rows="5" required></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">

                                        <select class="form-control" name="values[]" style="border-color: #ccc; width: 300px; display: inline-block;">
                                            <option value="">Add a student goal</option>
                                            <option value="4">Goal 4</option>
                                        </select>
                                        <span class="btn btn-default" style="padding: 15px 12px; height: 50px; background: #ff9f1a; color: #fff; border-radius: 0; margin-left: -5px; margin-top: -3px;">
                                            <span class="glyphicon glyphicon-plus"></span>
                                        </span>

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12 StudentGoals">

                                        <div class="panel panel-info autocollapse aStudentGoal" style="margin: 5px 0">
                                            <div class="panel-heading clickable">
                                                <h3 class="panel-title">
                                                    <i class="fa fa-trophy"></i>&nbsp;Goal 1
                                                    <i class="pull-right glyphicon glyphicon-remove deletegoal"></i>
                                                </h3>
                                            </div>
                                        </div>
                                        <div class="panel panel-info autocollapse aStudentGoal" style="margin: 5px 0">
                                            <div class="panel-heading clickable">
                                                <h3 class="panel-title">
                                                    <i class="fa fa-trophy"></i>&nbsp;Goal 2
                                                    <i class="pull-right glyphicon glyphicon-remove deletegoal"></i>
                                                </h3>
                                            </div>
                                        </div>
                                        <div class="panel panel-info autocollapse aStudentGoal" style="margin: 5px 0">
                                            <div class="panel-heading clickable">
                                                <h3 class="panel-title">
                                                    <i class="fa fa-trophy"></i>&nbsp;Goal 3
                                                    <i class="pull-right glyphicon glyphicon-remove deletegoal"></i>
                                                </h3>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>

</div>
<div class="modal-footer">
    <button type="button" class="btn btn-default btn-lg" data-dismiss="modal">Close</button>
</div>

<script>
    /* Binding */
    /* tooltips */
    $('[data-toggle="tooltip"]').tooltip({
        trigger: 'manual'
    });

    /* Event */
    /* When a user clicks on the question mark icon we turn on tooltips */
    $('.tooltip-help').on('click', function () {
        $('[data-toggle="tooltip"]').tooltip('toggle');
    });

    /* Event */
    /* when the form is submitted we need to remove the default code elements */
    $("form").on("submit", function () {
        $("tr#defaultrow").remove();

        $("#EditStudentGoalsForm").submit();
    });

    /* Event */
    /* when clicking on the New Student Goal button */
    $('#newgoal').on('click', function () {
        var cloneGoal = $("#defaultgoal").clone();
        cloneGoal.removeClass("hidden");
        cloneGoal.removeAttr("id");

        var goalCount = $('.oneStudentGoal').not("#defaultgoal").length + 1;
        cloneGoal.children().children().prop("id", "accordion[" + goalCount + "]");

        var goalA = cloneGoal.find('[data-parent="#accordion[0]"]').attr('data-parent', '#accordion[' + goalCount + ']');
        goalA.attr('href', '#collapse' + goalCount);

        var needService = cloneGoal.find('i.needService').attr('name', 'hasService[' + goalCount + ']');
        needService.next().attr('name', 'hasService[' + goalCount + ']');

        var defaultRow = cloneGoal.find("#defaultrow").removeAttr('id');

        $.each($('.oneStudentGoal').not("#defaultgoal").find('.collapse'), function (index, value) {
            $(this).removeClass("in");
        });

        cloneGoal.find("#collapse0").prop("id", "collapse" + goalCount);
        $('.goalContainer').append(cloneGoal);

        initGoal();
    });

    function initGoal() {
        $('.oneStudentGoal').not('#defaultgoal').not('.bound').addClass('bound').each(function (index) {

            //* Binding */
            /* fires when changing the goal title. It updates the accordian label too. */
            $(this).find(".studentGoalTitle").on("keyup blur", function (e) {
                var title = $(e.target).val();

                if (title != "") {
                    var label = $(e.target).parentsUntil('.oneStudentGoal ').find('.studentGoalLabel');
                    label.text(title);
                } else {
                    $(e.target).val('Student Goal');
                    $(e.target).parentsUntil('.oneStudentGoal ').find('.studentGoalLabel').text('Student Goal');
                    $(e.target).focus();
                    alert("The goal title cannot be blank");
                }
            });

            //* Binding */
            /* when the student clicks the hand icon for service */
            $(this).find("a i.needService").on("click", function (e) {
                if ($(e.target).hasClass('needService')) {
                    e.stopPropagation();

                    if ($(this).css("opacity") == 1) {
                        $(this).css('opacity', '0.2');
                        $(this).next().prop("checked", false);
                        $(this).next().val("false");
                    }
                    else {
                        $(this).css('opacity', '1');
                        $(this).next().prop("checked", "checked");
                        $(this).next().val("true");
                    }
                }
            });

            /* Binding */
            /* Fires where the user deletes a goal */
            $(this).find("a i.deleteGoal").on("click", function (e) {
                if ($(e.target).hasClass('deleteGoal')) {
                    e.stopPropagation();

                    var answer = confirm('Are you sure you want to delete this student service?');
                    if (answer) {
                        $(e.target).parentsUntil(".oneStudentGoal").remove();
                    }
                }
            });

            //* Binding */
            //* Adds a new objective when the user clicks the new objective button */
            $(this).find(".newObjectiveBenchmark").on("click", function (e) {
                event.preventDefault();

                var $clonerow = $('#defaultrow').clone().show();
                $clonerow.removeAttr("id");

                $(this).parent().find("tr.studentProgress").before($clonerow);

                initObjectives();
            });

            $(this).find(".number-spinner button").on("click", function () {
                var btn = $(this),
                    oldValue = btn.closest('.number-spinner').find('input').val().trim(),
                    newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < 7) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.number-spinner').find('input').val(newValue);
            });


            $(this).find(".minute-spinner button").on("click", function () {
                var btn = $(this),
                    oldValue = btn.closest('.minute-spinner').find('input').val().trim(),
                    newValue = parseInt(oldValue);

                if (btn.attr('data-dir') == 'up') {
                    if (newValue < 720) {
                        newValue = newValue + 1;
                    }
                } else {
                    if (oldValue > 1) {
                        newValue = newValue - 1;
                    }
                }

                btn.closest('.minute-spinner').find('input').val(newValue);
            });

            initObjectives();
        });
    }
    initGoal();

    function initObjectives() {
        $(".aStudentGoal").not(".bound").addClass("bound").each(function (index) {

            console.log($(this));
            /* Binding */
            //When the user clicks on the trash can to delete objective
            $(this).find(".deletegoal").on("click", function (e) {

                if (confirm("Do you really want to delete this goal?")) {
                    var row = $(e.target).closest('div.panel-info');
                    $(row).fadeOut(400, function () {
                        $(row).remove();
                    });
                }
            });

        });
    }

    /* Helper function */
    function endEdit(e) {
        var input = $(e.target),
            label = input && input.prev();

        label.text(input.val() === '' ? input.attr('placeholder') : input.val());
        input.hide();
        label.show();
    }

</script>